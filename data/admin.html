<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Admin - Loadcell Datalogger</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="header__title">
            <a href="index.html" style="color: inherit; text-decoration: none;">‚Üê Back</a>
            &nbsp;|&nbsp; Field Admin Mode
        </div>
        <span class="mode-badge mode-badge--admin">ADMIN</span>
    </header>

    <div class="container">
        <!-- Loadcell Configuration -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Loadcell Configuration</h2>
            </div>
            
            <div class="grid grid--2">
                <div class="form-group">
                    <label class="form-label">Loadcell ID</label>
                    <input type="text" class="form-input" id="cfg-loadcell-id" placeholder="TC023L0-000025">
                    <div class="form-hint">Unique identifier for this loadcell</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Model</label>
                    <input type="text" class="form-input" id="cfg-loadcell-model" placeholder="TC023L0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Serial Number</label>
                    <input type="text" class="form-input" id="cfg-loadcell-serial" placeholder="000025">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Capacity (kg)</label>
                    <input type="number" class="form-input" id="cfg-capacity" placeholder="2000" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Excitation Voltage (V)</label>
                    <input type="number" class="form-input" id="cfg-excitation" placeholder="10.0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sensitivity (mV/V)</label>
                    <input type="number" class="form-input" id="cfg-sensitivity" placeholder="2.0" step="0.001">
                    <div class="form-hint">Optional - from loadcell datasheet</div>
                </div>
            </div>
        </div>

        <!-- Calibration Points -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Calibration Points</h2>
                <button class="btn btn--small btn--secondary" onclick="addCalibrationPoint()">+ Add Point</button>
            </div>
            
            <p class="text-muted">Enter known loads and their corresponding ADC output in ¬µV.</p>
            
            <table class="table mt-md">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Load (kg)</th>
                        <th>Output (¬µV)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="calibration-table">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
            
            <div class="mt-md flex gap-md">
                <button class="btn btn--secondary" onclick="readCurrentAdc()">
                    üìä Read Current ADC
                </button>
                <button class="btn btn--secondary" onclick="autoZero()">
                    ‚öñ Auto Zero
                </button>
            </div>
        </div>

        <!-- ADC Configuration -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">ADC Configuration (MAX11270)</h2>
            </div>
            
            <div class="grid grid--2">
                <div class="form-group">
                    <label class="form-label">PGA Gain</label>
                    <select class="form-select" id="cfg-pga-gain">
                        <option value="1">1x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                        <option value="8">8x</option>
                        <option value="16">16x</option>
                        <option value="32">32x</option>
                        <option value="64">64x</option>
                        <option value="128" selected>128x</option>
                    </select>
                    <div class="form-hint">Higher gain = more sensitivity, less range</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sample Rate</label>
                    <select class="form-select" id="cfg-sample-rate">
                        <option value="1920">1.92 kSPS</option>
                        <option value="3840">3.84 kSPS</option>
                        <option value="7680">7.68 kSPS</option>
                        <option value="15360">15.36 kSPS</option>
                        <option value="30720">30.72 kSPS</option>
                        <option value="61440" selected>61.44 kSPS</option>
                    </select>
                </div>
            </div>
            
            <!-- Live ADC Reading -->
            <div class="mt-md" style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-md);">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <span class="text-muted">Current ADC Reading:</span>
                    <span style="font-family: monospace; font-size: 1.5rem;" id="live-adc">--</span>
                </div>
                <div class="flex mt-sm" style="justify-content: space-between; align-items: center;">
                    <span class="text-muted">Converted (¬µV):</span>
                    <span style="font-family: monospace; font-size: 1.2rem;" id="live-uv">--</span>
                </div>
            </div>
        </div>

        <!-- IMU Configuration -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">IMU Configuration (LSM6DSV)</h2>
            </div>
            
            <div class="grid grid--2">
                <div class="form-group">
                    <label class="form-label">Accelerometer Range</label>
                    <select class="form-select" id="cfg-imu-g-range">
                        <option value="2">¬±2g</option>
                        <option value="4">¬±4g</option>
                        <option value="8">¬±8g</option>
                        <option value="16" selected>¬±16g</option>
                    </select>
                    <div class="form-hint">Higher range = more dynamic range, less precision</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Gyroscope Range</label>
                    <select class="form-select" id="cfg-imu-gyro-dps">
                        <option value="125">¬±125 dps</option>
                        <option value="250">¬±250 dps</option>
                        <option value="500">¬±500 dps</option>
                        <option value="1000">¬±1000 dps</option>
                        <option value="2000" selected>¬±2000 dps</option>
                    </select>
                </div>
            </div>
            
            <!-- Live IMU Reading -->
            <div class="mt-md" style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-md);">
                <div class="grid grid--3" style="text-align: center;">
                    <div>
                        <div class="text-muted">Accel X</div>
                        <div style="font-family: monospace;" id="live-ax">--</div>
                    </div>
                    <div>
                        <div class="text-muted">Accel Y</div>
                        <div style="font-family: monospace;" id="live-ay">--</div>
                    </div>
                    <div>
                        <div class="text-muted">Accel Z</div>
                        <div style="font-family: monospace;" id="live-az">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Actions -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Save Configuration</h2>
            </div>
            
            <div class="alert alert--info">
                <span>‚ö† Configuration will be saved to device NVS (non-volatile storage). Changes persist across power cycles.</span>
            </div>
            
            <div class="flex gap-md mt-md">
                <button class="btn btn--success btn--large" onclick="saveConfig()">
                    üíæ Save to Device
                </button>
                <button class="btn btn--secondary" onclick="loadConfig()">
                    ‚Üª Reload from Device
                </button>
                <button class="btn btn--secondary" onclick="exportConfig()">
                    üì§ Export JSON
                </button>
                <button class="btn btn--secondary" onclick="importConfig()">
                    üì• Import JSON
                </button>
            </div>
        </div>

        <!-- Exit Mode -->
        <div class="card">
            <button class="btn btn--secondary btn--block" onclick="exitAdminMode()">
                Exit Admin Mode
            </button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let calibrationPoints = [];
        let liveUpdateInterval = null;

        // Initialize calibration table with default points
        function initCalibrationTable() {
            calibrationPoints = [
                { load_kg: 0, output_uV: 0 },
                { load_kg: 500, output_uV: 2500 },
                { load_kg: 1000, output_uV: 5000 },
                { load_kg: 1500, output_uV: 7500 },
                { load_kg: 2000, output_uV: 10000 }
            ];
            renderCalibrationTable();
        }

        function renderCalibrationTable() {
            const tbody = document.getElementById('calibration-table');
            tbody.innerHTML = calibrationPoints.map((point, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        <input type="number" class="form-input" value="${point.load_kg}" 
                               onchange="updateCalPoint(${i}, 'load_kg', this.value)" step="0.1">
                    </td>
                    <td>
                        <input type="number" class="form-input" value="${point.output_uV}" 
                               onchange="updateCalPoint(${i}, 'output_uV', this.value)" step="0.1">
                    </td>
                    <td>
                        <button class="btn btn--small btn--secondary" onclick="useCurrentReading(${i})">üìä Use Current</button>
                        ${i > 1 ? `<button class="btn btn--small btn--danger" onclick="removeCalPoint(${i})">‚úï</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function addCalibrationPoint() {
            const lastPoint = calibrationPoints[calibrationPoints.length - 1];
            calibrationPoints.push({
                load_kg: lastPoint.load_kg + 500,
                output_uV: lastPoint.output_uV + 2500
            });
            renderCalibrationTable();
        }

        function removeCalPoint(index) {
            if (calibrationPoints.length > 2) {
                calibrationPoints.splice(index, 1);
                renderCalibrationTable();
            }
        }

        function updateCalPoint(index, field, value) {
            calibrationPoints[index][field] = parseFloat(value);
        }

        async function useCurrentReading(index) {
            try {
                const data = await API.get('/api/live');
                calibrationPoints[index].output_uV = data.raw_adc || 0;
                renderCalibrationTable();
                UI.showAlert(`Point ${index + 1} updated with current reading`, 'success');
            } catch (error) {
                UI.showAlert('Failed to read current value', 'error');
            }
        }

        async function readCurrentAdc() {
            try {
                const data = await API.get('/api/live');
                document.getElementById('live-adc').textContent = data.raw_adc?.toLocaleString() || '--';
                document.getElementById('live-uv').textContent = (data.raw_adc / 100)?.toFixed(2) + ' ¬µV' || '--';
            } catch (error) {
                UI.showAlert('Failed to read ADC', 'error');
            }
        }

        async function autoZero() {
            UI.showModal('Auto Zero', 
                '<p>Remove all load from the loadcell and click Confirm to set zero point.</p>',
                async () => {
                    try {
                        const data = await API.get('/api/live');
                        calibrationPoints[0] = { load_kg: 0, output_uV: data.raw_adc || 0 };
                        renderCalibrationTable();
                        UI.showAlert('Zero point set successfully', 'success');
                    } catch (error) {
                        UI.showAlert('Failed to auto-zero', 'error');
                    }
                }
            );
        }

        // Load configuration from device
        async function loadConfig() {
            try {
                const config = await API.get('/api/config');
                
                // Populate form fields
                document.getElementById('cfg-loadcell-id').value = config.loadcell_id || '';
                document.getElementById('cfg-loadcell-model').value = config.loadcell_model || '';
                document.getElementById('cfg-loadcell-serial').value = config.loadcell_serial || '';
                document.getElementById('cfg-capacity').value = config.capacity_kg || '';
                document.getElementById('cfg-excitation').value = config.excitation_V || '';
                document.getElementById('cfg-sensitivity').value = config.sensitivity_mVV || '';
                document.getElementById('cfg-pga-gain').value = config.adc_pga_gain || 128;
                document.getElementById('cfg-imu-g-range').value = config.imu_g_range || 16;
                document.getElementById('cfg-imu-gyro-dps').value = config.imu_gyro_dps || 2000;
                
                // Load calibration points
                if (config.calibration_points && config.calibration_points.length > 0) {
                    calibrationPoints = config.calibration_points;
                    renderCalibrationTable();
                }
                
                UI.showAlert('Configuration loaded', 'success');
            } catch (error) {
                UI.showAlert('Failed to load configuration', 'error');
            }
        }

        // Save configuration to device
        async function saveConfig() {
            const config = {
                loadcell_id: document.getElementById('cfg-loadcell-id').value,
                loadcell_model: document.getElementById('cfg-loadcell-model').value,
                loadcell_serial: document.getElementById('cfg-loadcell-serial').value,
                capacity_kg: parseFloat(document.getElementById('cfg-capacity').value) || 2000,
                excitation_V: parseFloat(document.getElementById('cfg-excitation').value) || 10,
                sensitivity_mVV: parseFloat(document.getElementById('cfg-sensitivity').value) || 0,
                adc_pga_gain: parseInt(document.getElementById('cfg-pga-gain').value),
                imu_g_range: parseInt(document.getElementById('cfg-imu-g-range').value),
                imu_gyro_dps: parseInt(document.getElementById('cfg-imu-gyro-dps').value),
                calibration_points: calibrationPoints
            };
            
            try {
                await API.post('/api/config', config);
                UI.showAlert('Configuration saved to device', 'success');
            } catch (error) {
                UI.showAlert('Failed to save configuration', 'error');
            }
        }

        // Export configuration as JSON
        function exportConfig() {
            const config = {
                loadcell_id: document.getElementById('cfg-loadcell-id').value,
                loadcell_model: document.getElementById('cfg-loadcell-model').value,
                loadcell_serial: document.getElementById('cfg-loadcell-serial').value,
                capacity_kg: parseFloat(document.getElementById('cfg-capacity').value),
                excitation_V: parseFloat(document.getElementById('cfg-excitation').value),
                adc_pga_gain: parseInt(document.getElementById('cfg-pga-gain').value),
                imu_g_range: parseInt(document.getElementById('cfg-imu-g-range').value),
                imu_gyro_dps: parseInt(document.getElementById('cfg-imu-gyro-dps').value),
                calibration_points: calibrationPoints
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loadcell_config_${config.loadcell_id || 'export'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import configuration from JSON
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const config = JSON.parse(text);
                    
                    // Populate form
                    if (config.loadcell_id) document.getElementById('cfg-loadcell-id').value = config.loadcell_id;
                    if (config.loadcell_model) document.getElementById('cfg-loadcell-model').value = config.loadcell_model;
                    if (config.loadcell_serial) document.getElementById('cfg-loadcell-serial').value = config.loadcell_serial;
                    if (config.capacity_kg) document.getElementById('cfg-capacity').value = config.capacity_kg;
                    if (config.excitation_V) document.getElementById('cfg-excitation').value = config.excitation_V;
                    if (config.adc_pga_gain) document.getElementById('cfg-pga-gain').value = config.adc_pga_gain;
                    if (config.imu_g_range) document.getElementById('cfg-imu-g-range').value = config.imu_g_range;
                    if (config.imu_gyro_dps) document.getElementById('cfg-imu-gyro-dps').value = config.imu_gyro_dps;
                    
                    if (config.calibration_points) {
                        calibrationPoints = config.calibration_points;
                        renderCalibrationTable();
                    }
                    
                    UI.showAlert('Configuration imported', 'success');
                } catch (error) {
                    UI.showAlert('Failed to import: Invalid JSON', 'error');
                }
            };
            input.click();
        }

        // Start live updates
        function startLiveUpdates() {
            liveUpdateInterval = setInterval(async () => {
                try {
                    const data = await API.get('/api/live');
                    document.getElementById('live-adc').textContent = data.raw_adc?.toLocaleString() || '--';
                    document.getElementById('live-uv').textContent = ((data.raw_adc || 0) / 100).toFixed(2) + ' ¬µV';
                    document.getElementById('live-ax').textContent = data.accel_x?.toFixed(3) + ' g' || '--';
                    document.getElementById('live-ay').textContent = data.accel_y?.toFixed(3) + ' g' || '--';
                    document.getElementById('live-az').textContent = data.accel_z?.toFixed(3) + ' g' || '--';
                } catch (error) {
                    // Silently fail for live updates
                }
            }, 500);
        }

        function stopLiveUpdates() {
            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
                liveUpdateInterval = null;
            }
        }

        // Exit admin mode
        async function exitAdminMode() {
            stopLiveUpdates();
            const success = await Mode.switchTo('user');
            if (success) {
                location.href = 'index.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCalibrationTable();
            loadConfig();
            startLiveUpdates();
            
            // Verify we're in admin mode
            Mode.fetch().then(mode => {
                if (mode !== 'admin') {
                    UI.showAlert('Not in Admin mode. Please switch modes from the main page.', 'warning');
                }
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopLiveUpdates();
        });
    </script>
</body>
</html>

