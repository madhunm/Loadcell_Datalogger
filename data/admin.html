<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Admin - Loadcell Datalogger</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="header__title">
            <a href="index.html" style="color: inherit; text-decoration: none;">‚Üê Back</a>
            &nbsp;|&nbsp; Field Admin Mode
        </div>
        <span class="mode-badge mode-badge--admin">ADMIN</span>
    </header>

    <div class="container">
        <!-- Loadcell Configuration -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Loadcell Configuration</h2>
            </div>
            
            <div class="grid grid--2">
                <div class="form-group">
                    <label class="form-label">Loadcell ID</label>
                    <input type="text" class="form-input" id="cfg-loadcell-id" value="TC023L0-000025" placeholder="TC023L0-000025">
                    <div class="form-hint">Unique identifier for this loadcell</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Model</label>
                    <input type="text" class="form-input" id="cfg-loadcell-model" value="TC023L0" placeholder="TC023L0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Serial Number</label>
                    <input type="text" class="form-input" id="cfg-loadcell-serial" value="000025" placeholder="000025">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Capacity (kg)</label>
                    <input type="number" class="form-input" id="cfg-capacity" value="2000" placeholder="2000" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Excitation Voltage (V)</label>
                    <input type="number" class="form-input" id="cfg-excitation" value="3.3" placeholder="3.3" step="0.1">
                    <div class="form-hint">Your hardware uses 3.3V excitation</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sensitivity (mV/V)</label>
                    <input type="number" class="form-input" id="cfg-sensitivity" value="1.372" placeholder="1.372" step="0.001">
                    <div class="form-hint">From calibration certificate</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Zero Balance (¬µV at excitation)</label>
                    <input type="number" class="form-input" id="cfg-zero-balance" value="18" placeholder="18" step="0.1">
                    <div class="form-hint">Initial offset at zero load (scaled for 3.3V)</div>
                </div>
            </div>
        </div>

        <!-- Calibration Points -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Calibration Points</h2>
                <button class="btn btn--small btn--secondary" onclick="addCalibrationPoint()">+ Add Point</button>
            </div>
            
            <p class="text-muted">Enter known loads and their corresponding ADC output in ¬µV.</p>
            
            <table class="table mt-md">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Load (kg)</th>
                        <th>Output (¬µV)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="calibration-table">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
            
            <div class="mt-md flex gap-md">
                <button class="btn btn--secondary" onclick="readCurrentAdc()">
                    üìä Read Current ADC
                </button>
                <button class="btn btn--secondary" onclick="autoZero()">
                    ‚öñ Auto Zero
                </button>
            </div>
        </div>

        <!-- ADC Configuration -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">ADC Configuration (MAX11270)</h2>
            </div>
            
            <div class="grid grid--2">
                <div class="form-group">
                    <label class="form-label">PGA Gain</label>
                    <select class="form-select" id="cfg-pga-gain">
                        <option value="1">1x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                        <option value="8">8x</option>
                        <option value="16">16x</option>
                        <option value="32">32x</option>
                        <option value="64">64x</option>
                        <option value="128" selected>128x</option>
                    </select>
                    <div class="form-hint">Higher gain = more sensitivity, less range</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sample Rate</label>
                    <select class="form-select" id="cfg-sample-rate">
                        <option value="1920">1.92 kSPS</option>
                        <option value="3840">3.84 kSPS</option>
                        <option value="7680">7.68 kSPS</option>
                        <option value="15360">15.36 kSPS</option>
                        <option value="30720">30.72 kSPS</option>
                        <option value="61440" selected>61.44 kSPS</option>
                    </select>
                </div>
            </div>
            
            <!-- Live ADC Reading -->
            <div class="mt-md" style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-md);">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <span class="text-muted">Current ADC Reading:</span>
                    <span style="font-family: monospace; font-size: 1.5rem;" id="live-adc">--</span>
                </div>
                <div class="flex mt-sm" style="justify-content: space-between; align-items: center;">
                    <span class="text-muted">Converted (¬µV):</span>
                    <span style="font-family: monospace; font-size: 1.2rem;" id="live-uv">--</span>
                </div>
            </div>
        </div>

        <!-- IMU Configuration -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">IMU Configuration (LSM6DSV)</h2>
            </div>
            
            <div class="grid grid--2">
                <div class="form-group">
                    <label class="form-label">Accelerometer Range</label>
                    <select class="form-select" id="cfg-imu-g-range">
                        <option value="2">¬±2g</option>
                        <option value="4">¬±4g</option>
                        <option value="8">¬±8g</option>
                        <option value="16" selected>¬±16g</option>
                    </select>
                    <div class="form-hint">Higher range = more dynamic range, less precision</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Gyroscope Range</label>
                    <select class="form-select" id="cfg-imu-gyro-dps">
                        <option value="125">¬±125 dps</option>
                        <option value="250">¬±250 dps</option>
                        <option value="500">¬±500 dps</option>
                        <option value="1000">¬±1000 dps</option>
                        <option value="2000" selected>¬±2000 dps</option>
                    </select>
                </div>
            </div>
            
            <!-- Live IMU Reading -->
            <div class="mt-md" style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-md);">
                <div class="grid grid--3" style="text-align: center;">
                    <div>
                        <div class="text-muted">Accel X</div>
                        <div style="font-family: monospace;" id="live-ax">--</div>
                    </div>
                    <div>
                        <div class="text-muted">Accel Y</div>
                        <div style="font-family: monospace;" id="live-ay">--</div>
                    </div>
                    <div>
                        <div class="text-muted">Accel Z</div>
                        <div style="font-family: monospace;" id="live-az">--</div>
                    </div>
                </div>
                <div class="grid grid--3 mt-md" style="text-align: center;">
                    <div>
                        <div class="text-muted">Gyro X</div>
                        <div style="font-family: monospace;" id="live-gx">--</div>
                    </div>
                    <div>
                        <div class="text-muted">Gyro Y</div>
                        <div style="font-family: monospace;" id="live-gy">--</div>
                    </div>
                    <div>
                        <div class="text-muted">Gyro Z</div>
                        <div style="font-family: monospace;" id="live-gz">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Actions -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Save Configuration</h2>
            </div>
            
            <div class="alert alert--info">
                <span>‚ö† Configuration will be saved to device NVS (non-volatile storage). Changes persist across power cycles.</span>
            </div>
            
            <div class="flex gap-md mt-md">
                <button class="btn btn--success btn--large" onclick="saveConfig()">
                    üíæ Save to Device
                </button>
                <button class="btn btn--secondary" onclick="loadConfig()">
                    ‚Üª Reload from Device
                </button>
                <button class="btn btn--secondary" onclick="exportConfig()">
                    üì§ Export JSON
                </button>
                <button class="btn btn--secondary" onclick="importConfig()">
                    üì• Import JSON
                </button>
            </div>
        </div>

        <!-- Firmware Update -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Firmware Update (OTA)</h2>
            </div>
            
            <div class="alert alert--warning">
                <span>‚ö† Do not disconnect power during update. Device will restart automatically.</span>
            </div>
            
            <div class="form-group mt-md">
                <label class="form-label">Firmware File (.bin)</label>
                <input type="file" class="form-input" id="ota-file" accept=".bin">
                <div class="form-hint">Select compiled firmware.bin file</div>
            </div>
            
            <div class="progress-bar mt-md" style="display: none;" id="ota-progress-container">
                <div class="progress-bar__fill progress-bar__fill--success" id="ota-progress" style="width: 0%;"></div>
            </div>
            <div class="text-center mt-sm" id="ota-status"></div>
            
            <button class="btn btn--primary btn--block mt-md" onclick="uploadFirmware()" id="btn-ota-upload">
                üì§ Upload & Install Firmware
            </button>
        </div>

        <!-- Exit Mode -->
        <div class="card">
            <button class="btn btn--secondary btn--block" onclick="exitAdminMode()">
                Exit Admin Mode
            </button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let calibrationPoints = [];
        let liveUpdateInterval = null;

        // Initialize calibration table with TC023L0-000025 default points
        // (Scaled for 3.3V excitation from 10V certificate values)
        function initCalibrationTable() {
            calibrationPoints = [
                { load_kg: 0, output_uV: 0 },
                { load_kg: 200, output_uV: 450 },
                { load_kg: 400, output_uV: 901 },
                { load_kg: 600, output_uV: 1352 },
                { load_kg: 800, output_uV: 1804 },
                { load_kg: 1000, output_uV: 2256 },
                { load_kg: 1200, output_uV: 2709 },
                { load_kg: 1400, output_uV: 3162 },
                { load_kg: 1600, output_uV: 3617 },
                { load_kg: 1800, output_uV: 4072 },
                { load_kg: 2000, output_uV: 4528 }
            ];
            renderCalibrationTable();
        }

        function renderCalibrationTable() {
            const tbody = document.getElementById('calibration-table');
            tbody.innerHTML = calibrationPoints.map((point, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        <input type="number" class="form-input" value="${point.load_kg}" 
                               onchange="updateCalPoint(${i}, 'load_kg', this.value)" step="0.1">
                    </td>
                    <td>
                        <input type="number" class="form-input" value="${point.output_uV}" 
                               onchange="updateCalPoint(${i}, 'output_uV', this.value)" step="0.1">
                    </td>
                    <td>
                        <button class="btn btn--small btn--secondary" onclick="useCurrentReading(${i})">üìä Use Current</button>
                        ${i > 1 ? `<button class="btn btn--small btn--danger" onclick="removeCalPoint(${i})">‚úï</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function addCalibrationPoint() {
            const lastPoint = calibrationPoints[calibrationPoints.length - 1];
            calibrationPoints.push({
                load_kg: lastPoint.load_kg + 500,
                output_uV: lastPoint.output_uV + 2500
            });
            renderCalibrationTable();
        }

        function removeCalPoint(index) {
            if (calibrationPoints.length > 2) {
                calibrationPoints.splice(index, 1);
                renderCalibrationTable();
            }
        }

        function updateCalPoint(index, field, value) {
            calibrationPoints[index][field] = parseFloat(value);
        }

        async function useCurrentReading(index) {
            try {
                const data = await API.get('/api/live');
                // Use voltage_uV instead of raw_adc for calibration points
                calibrationPoints[index].output_uV = data.voltage_uV || 0;
                renderCalibrationTable();
                UI.showAlert(`Point ${index + 1} updated: ${data.voltage_uV?.toFixed(1)} ¬µV`, 'success');
            } catch (error) {
                UI.showAlert('Failed to read current value', 'error');
            }
        }

        async function readCurrentAdc() {
            try {
                const data = await API.get('/api/live');
                document.getElementById('live-adc').textContent = data.raw_adc?.toLocaleString() || '--';
                // Use voltage_uV from API (properly converted by firmware)
                document.getElementById('live-uv').textContent = (data.voltage_uV?.toFixed(1) || '--') + ' ¬µV';
            } catch (error) {
                UI.showAlert('Failed to read ADC', 'error');
            }
        }

        async function autoZero() {
            UI.showModal('Auto Zero', 
                '<p>Remove all load from the loadcell and click Confirm to set zero point.</p>',
                async () => {
                    try {
                        const data = await API.get('/api/live');
                        // Use voltage_uV for calibration
                        calibrationPoints[0] = { load_kg: 0, output_uV: data.voltage_uV || 0 };
                        renderCalibrationTable();
                        UI.showAlert(`Zero point set: ${data.voltage_uV?.toFixed(1)} ¬µV`, 'success');
                    } catch (error) {
                        UI.showAlert('Failed to auto-zero', 'error');
                    }
                }
            );
        }

        // Load configuration from device
        async function loadConfig() {
            try {
                const config = await API.get('/api/config');
                
                if (config.loaded) {
                    // Populate form fields from device
                    document.getElementById('cfg-loadcell-id').value = config.loadcell_id || '';
                    document.getElementById('cfg-loadcell-model').value = config.loadcell_model || '';
                    document.getElementById('cfg-loadcell-serial').value = config.loadcell_serial || '';
                    document.getElementById('cfg-capacity').value = config.capacity_kg || '';
                    document.getElementById('cfg-excitation').value = config.excitation_V || 3.3;
                    document.getElementById('cfg-sensitivity').value = config.sensitivity_mVV || '';
                    document.getElementById('cfg-zero-balance').value = config.zero_balance_uV || 0;
                    
                    // Load calibration points
                    if (config.calibration_points && config.calibration_points.length > 0) {
                        calibrationPoints = config.calibration_points;
                        renderCalibrationTable();
                    }
                    
                    UI.showAlert('Configuration loaded from device', 'success');
                } else {
                    UI.showAlert('No calibration stored on device - using defaults', 'info');
                }
            } catch (error) {
                console.log('Config load error:', error);
                // Keep defaults on error
            }
        }

        // Save configuration to device
        async function saveConfig() {
            const config = {
                loadcell_id: document.getElementById('cfg-loadcell-id').value,
                loadcell_model: document.getElementById('cfg-loadcell-model').value,
                loadcell_serial: document.getElementById('cfg-loadcell-serial').value,
                capacity_kg: parseFloat(document.getElementById('cfg-capacity').value) || 2000,
                excitation_V: parseFloat(document.getElementById('cfg-excitation').value) || 3.3,
                sensitivity_mVV: parseFloat(document.getElementById('cfg-sensitivity').value) || 1.372,
                zero_balance_uV: parseFloat(document.getElementById('cfg-zero-balance').value) || 0,
                calibration_points: calibrationPoints
            };
            
            try {
                const result = await API.post('/api/config', config);
                UI.showAlert(`Calibration saved: ${result.id} (${result.points} points)`, 'success');
            } catch (error) {
                UI.showAlert('Failed to save: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Export configuration as JSON
        function exportConfig() {
            const config = {
                loadcell_id: document.getElementById('cfg-loadcell-id').value,
                loadcell_model: document.getElementById('cfg-loadcell-model').value,
                loadcell_serial: document.getElementById('cfg-loadcell-serial').value,
                capacity_kg: parseFloat(document.getElementById('cfg-capacity').value),
                excitation_V: parseFloat(document.getElementById('cfg-excitation').value),
                sensitivity_mVV: parseFloat(document.getElementById('cfg-sensitivity').value),
                zero_balance_uV: parseFloat(document.getElementById('cfg-zero-balance').value),
                calibration_points: calibrationPoints
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loadcell_config_${config.loadcell_id || 'export'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import configuration from JSON
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const config = JSON.parse(text);
                    
                    // Populate form
                    if (config.loadcell_id) document.getElementById('cfg-loadcell-id').value = config.loadcell_id;
                    if (config.loadcell_model) document.getElementById('cfg-loadcell-model').value = config.loadcell_model;
                    if (config.loadcell_serial) document.getElementById('cfg-loadcell-serial').value = config.loadcell_serial;
                    if (config.capacity_kg) document.getElementById('cfg-capacity').value = config.capacity_kg;
                    if (config.excitation_V) document.getElementById('cfg-excitation').value = config.excitation_V;
                    if (config.sensitivity_mVV) document.getElementById('cfg-sensitivity').value = config.sensitivity_mVV;
                    if (config.zero_balance_uV !== undefined) document.getElementById('cfg-zero-balance').value = config.zero_balance_uV;
                    
                    if (config.calibration_points) {
                        calibrationPoints = config.calibration_points;
                        renderCalibrationTable();
                    }
                    
                    UI.showAlert('Configuration imported - click Save to store on device', 'success');
                } catch (error) {
                    UI.showAlert('Failed to import: Invalid JSON', 'error');
                }
            };
            input.click();
        }

        // SSE Event Source for real-time streaming
        let eventSource = null;
        
        function handleStreamData(data) {
            document.getElementById('live-adc').textContent = data.adc?.toLocaleString() || '--';
            document.getElementById('live-uv').textContent = (data.uV || 0).toFixed(1) + ' ¬µV';
            document.getElementById('live-ax').textContent = (data.ax?.toFixed(3) || '--') + ' g';
            document.getElementById('live-ay').textContent = (data.ay?.toFixed(3) || '--') + ' g';
            document.getElementById('live-az').textContent = (data.az?.toFixed(3) || '--') + ' g';
            document.getElementById('live-gx').textContent = (data.gx?.toFixed(1) || '--') + ' dps';
            document.getElementById('live-gy').textContent = (data.gy?.toFixed(1) || '--') + ' dps';
            document.getElementById('live-gz').textContent = (data.gz?.toFixed(1) || '--') + ' dps';
        }
        
        function startLiveUpdates() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/api/stream');
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleStreamData(data);
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            };
            
            eventSource.onerror = () => {
                console.log('SSE connection lost, reconnecting...');
                eventSource.close();
                eventSource = null;
                setTimeout(startLiveUpdates, 1000);
            };
            
            eventSource.onopen = () => {
                console.log('SSE stream connected');
            };
        }

        function stopLiveUpdates() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        // OTA Firmware upload
        async function uploadFirmware() {
            const fileInput = document.getElementById('ota-file');
            const file = fileInput.files[0];
            
            if (!file) {
                UI.showAlert('Please select a firmware file', 'warning');
                return;
            }
            
            if (!file.name.endsWith('.bin')) {
                UI.showAlert('Invalid file type. Please select a .bin file', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-ota-upload');
            const progressContainer = document.getElementById('ota-progress-container');
            const progressBar = document.getElementById('ota-progress');
            const statusDiv = document.getElementById('ota-status');
            
            btn.disabled = true;
            btn.textContent = 'Uploading...';
            progressContainer.style.display = 'block';
            statusDiv.textContent = 'Starting upload...';
            
            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        statusDiv.textContent = `Uploading: ${percent}%`;
                    }
                });
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        if (result.success) {
                            statusDiv.textContent = 'Update complete! Restarting device...';
                            statusDiv.style.color = 'var(--accent-green)';
                            UI.showAlert('Firmware update successful! Device is restarting...', 'success');
                            
                            // Redirect after device restarts
                            setTimeout(() => {
                                location.href = 'index.html';
                            }, 5000);
                        } else {
                            throw new Error(result.error || 'Update failed');
                        }
                    } else {
                        throw new Error('Upload failed: ' + xhr.statusText);
                    }
                };
                
                xhr.onerror = function() {
                    throw new Error('Network error during upload');
                };
                
                xhr.open('POST', '/api/ota', true);
                xhr.setRequestHeader('Content-Type', 'application/octet-stream');
                xhr.send(file);
                
            } catch (error) {
                statusDiv.textContent = 'Error: ' + error.message;
                statusDiv.style.color = 'var(--accent-red)';
                UI.showAlert('Firmware update failed: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'üì§ Upload & Install Firmware';
            }
        }

        // Exit admin mode
        async function exitAdminMode() {
            stopLiveUpdates();
            const success = await Mode.switchTo('user');
            if (success) {
                location.href = 'index.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCalibrationTable();
            loadConfig();
            startLiveUpdates();
            
            // Verify we're in admin mode
            Mode.fetch().then(mode => {
                if (mode !== 'admin') {
                    UI.showAlert('Not in Admin mode. Please switch modes from the main page.', 'warning');
                }
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopLiveUpdates();
        });
    </script>
</body>
</html>

