<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Test - Loadcell Datalogger</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="header">
        <div class="header__title">
            <a href="index.html" style="color: inherit; text-decoration: none;">← Back</a>
            &nbsp;|&nbsp; Factory Test Mode
        </div>
        <span class="mode-badge mode-badge--factory">FACTORY</span>
    </header>

    <div class="container">
        <!-- Test Summary -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Test Summary</h2>
                <div class="flex gap-md">
                    <button class="btn btn--primary" onclick="runAllTests()">
                        ▶ Run All Tests
                    </button>
                    <button class="btn btn--secondary" onclick="resetTests()">
                        ↺ Reset
                    </button>
                </div>
            </div>

            <div class="grid grid--5" style="text-align: center;">
                <div class="stat-card">
                    <div class="stat-card__value" id="summary-total">0</div>
                    <div class="stat-card__label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value stat-card__value--green" id="summary-pass">0</div>
                    <div class="stat-card__label">Pass</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value" style="color: var(--accent-red);" id="summary-fail">0</div>
                    <div class="stat-card__label">Fail</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value" style="color: var(--text-muted);" id="summary-pending">6</div>
                    <div class="stat-card__label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value" id="summary-result">--</div>
                    <div class="stat-card__label">Result</div>
                </div>
            </div>
        </div>

        <!-- Individual Tests -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Sensor Tests</h2>
            </div>

            <!-- ADC Test -->
            <div class="test-result test-result--pending" id="test-adc">
                <div>
                    <div class="test-result__name">MAX11270 ADC</div>
                    <div class="text-muted" id="test-adc-details">24-bit precision ADC for load cell</div>
                </div>
                <div class="test-result__status">
                    <span id="test-adc-status">Pending</span>
                    <button class="btn btn--small btn--secondary" onclick="runTest('adc')">Test</button>
                </div>
            </div>

            <!-- IMU Test -->
            <div class="test-result test-result--pending" id="test-imu">
                <div>
                    <div class="test-result__name">LSM6DSV IMU</div>
                    <div class="text-muted" id="test-imu-details">6-axis accelerometer + gyroscope</div>
                </div>
                <div class="test-result__status">
                    <span id="test-imu-status">Pending</span>
                    <button class="btn btn--small btn--secondary" onclick="runTest('imu')">Test</button>
                </div>
            </div>

            <!-- RTC Test -->
            <div class="test-result test-result--pending" id="test-rtc">
                <div>
                    <div class="test-result__name">RX8900CE RTC</div>
                    <div class="text-muted" id="test-rtc-details">Real-time clock with 1Hz output</div>
                </div>
                <div class="test-result__status">
                    <span id="test-rtc-status">Pending</span>
                    <button class="btn btn--small btn--secondary" onclick="runTest('rtc')">Test</button>
                </div>
            </div>

            <!-- SD Card Test -->
            <div class="test-result test-result--pending" id="test-sd">
                <div>
                    <div class="test-result__name">SD Card</div>
                    <div class="text-muted" id="test-sd-details">SDMMC 4-bit interface</div>
                </div>
                <div class="test-result__status">
                    <span id="test-sd-status">Pending</span>
                    <button class="btn btn--small btn--secondary" onclick="runTest('sd')">Test</button>
                </div>
            </div>

            <!-- NeoPixel Test -->
            <div class="test-result test-result--pending" id="test-neopixel">
                <div>
                    <div class="test-result__name">NeoPixel LED</div>
                    <div class="text-muted" id="test-neopixel-details">WS2812B status indicator</div>
                </div>
                <div class="test-result__status">
                    <span id="test-neopixel-status">Pending</span>
                    <button class="btn btn--small btn--secondary" onclick="runTest('neopixel')">Test</button>
                </div>
            </div>

            <!-- Battery/Fuel Gauge Test -->
            <div class="test-result test-result--pending" id="test-battery">
                <div>
                    <div class="test-result__name">MAX17048 Fuel Gauge</div>
                    <div class="text-muted" id="test-battery-details">Battery voltage and SOC</div>
                </div>
                <div class="test-result__status">
                    <span id="test-battery-status">Pending</span>
                    <button class="btn btn--small btn--secondary" onclick="runTest('battery')">Test</button>
                </div>
            </div>
        </div>

        <!-- NeoPixel Manual Test -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">NeoPixel LED Test</h2>
            </div>

            <!-- Current State Display -->
            <div
                style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                <div class="flex gap-md" style="align-items: center; justify-content: space-between;">
                    <div>
                        <div class="text-muted" style="font-size: 0.8rem;">Current State</div>
                        <div id="led-state-name" style="font-weight: 600; font-size: 1.1rem;">--</div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.8rem;">Progress</div>
                        <div id="led-state-progress" style="font-weight: 600;">0 / 0</div>
                    </div>
                    <div id="led-cycle-indicator" style="display: none; color: var(--accent-green);">
                        ◉ Auto-cycling
                    </div>
                </div>
            </div>

            <!-- Auto Cycle Controls -->
            <div class="flex gap-md mb-md">
                <button class="btn btn--primary" id="btn-cycle-toggle" onclick="toggleAutoCycle()">
                    ▶ Start Auto Cycle
                </button>
                <button class="btn btn--secondary" onclick="ledNext()">
                    Next →
                </button>
            </div>

            <!-- Color Selection -->
            <div class="mb-md">
                <div class="text-muted mb-sm" style="font-size: 0.85rem;">Colors (click to set)</div>
                <div class="flex gap-sm" style="flex-wrap: wrap;">
                    <button class="btn led-color-btn" style="background: #ff0000;" onclick="setLed('red')">Red</button>
                    <button class="btn led-color-btn" style="background: #00ff00; color: #000;"
                        onclick="setLed('green')">Green</button>
                    <button class="btn led-color-btn" style="background: #0000ff;"
                        onclick="setLed('blue')">Blue</button>
                    <button class="btn led-color-btn" style="background: #00ffff; color: #000;"
                        onclick="setLed('cyan')">Cyan</button>
                    <button class="btn led-color-btn" style="background: #ff6400; color: #000;"
                        onclick="setLed('orange')">Orange</button>
                    <button class="btn led-color-btn" style="background: #ff00ff;"
                        onclick="setLed('magenta')">Magenta</button>
                    <button class="btn btn--secondary" onclick="setLed('off')">Off</button>
                </div>
            </div>

            <!-- Pattern Selection -->
            <div class="mb-md">
                <div class="text-muted mb-sm" style="font-size: 0.85rem;">Patterns</div>
                <div class="flex gap-sm" style="flex-wrap: wrap;">
                    <button class="btn btn--secondary pattern-btn" data-pattern="steady"
                        onclick="setPattern('steady')">Steady</button>
                    <button class="btn btn--secondary pattern-btn" data-pattern="pulse"
                        onclick="setPattern('pulse')">Pulse</button>
                    <button class="btn btn--secondary pattern-btn" data-pattern="fast_blink"
                        onclick="setPattern('fast_blink')">Fast Blink</button>
                    <button class="btn btn--secondary pattern-btn" data-pattern="very_fast_blink"
                        onclick="setPattern('very_fast_blink')">Very Fast</button>
                </div>
            </div>

            <!-- Error Blink Codes -->
            <div>
                <div class="text-muted mb-sm" style="font-size: 0.85rem;">Error Blink Codes (Red)</div>
                <div class="flex gap-sm" style="flex-wrap: wrap;">
                    <button class="btn btn--secondary" style="border-color: #ff0000;" onclick="setBlinkCode(1)">1 (SD
                        Missing)</button>
                    <button class="btn btn--secondary" style="border-color: #ff0000;" onclick="setBlinkCode(2)">2 (SD
                        Full)</button>
                    <button class="btn btn--secondary" style="border-color: #ff0000;" onclick="setBlinkCode(3)">3 (SD
                        Write)</button>
                    <button class="btn btn--secondary" style="border-color: #ff0000;" onclick="setBlinkCode(4)">4
                        (ADC)</button>
                    <button class="btn btn--secondary" style="border-color: #ff0000;" onclick="setBlinkCode(5)">5
                        (IMU)</button>
                    <button class="btn btn--secondary" style="border-color: #ff0000;" onclick="setBlinkCode(6)">6
                        (RTC)</button>
                </div>
            </div>
        </div>

        <!-- Test Log -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Test Log</h2>
                <button class="btn btn--small btn--secondary" onclick="clearLog()">Clear</button>
            </div>
            <div id="test-log"
                style="font-family: monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto; background: var(--bg-input); padding: 1rem; border-radius: var(--radius-md);">
                <div class="text-muted">Test log will appear here...</div>
            </div>
        </div>

        <!-- Exit Mode -->
        <div class="card">
            <div class="flex gap-md">
                <button class="btn btn--secondary btn--block" onclick="exitFactoryMode()">
                    Exit Factory Mode
                </button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        const testResults = {
            adc: null,
            imu: null,
            rtc: null,
            sd: null,
            neopixel: null,
            battery: null
        };

        // Log message to test log
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'var(--text-secondary)',
                success: 'var(--accent-green)',
                error: 'var(--accent-red)',
                warning: 'var(--accent-orange)'
            };

            const entry = document.createElement('div');
            entry.style.color = colors[type] || colors.info;
            entry.textContent = `[${timestamp}] ${message}`;

            // Remove placeholder if present
            const placeholder = logDiv.querySelector('.text-muted');
            if (placeholder) placeholder.remove();

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML =
                '<div class="text-muted">Test log cleared...</div>';
        }

        // Run individual test
        async function runTest(sensor) {
            log(`Starting ${sensor.toUpperCase()} test...`);

            const testDiv = document.getElementById(`test-${sensor}`);
            const statusSpan = document.getElementById(`test-${sensor}-status`);
            const detailsDiv = document.getElementById(`test-${sensor}-details`);

            statusSpan.textContent = 'Testing...';
            testDiv.className = 'test-result test-result--pending';

            try {
                const result = await API.post(`/api/test/${sensor}`, {});
                testResults[sensor] = result;

                if (result.passed) {
                    log(`${sensor.toUpperCase()} test PASSED: ${result.message}`, 'success');
                    statusSpan.textContent = '✓ Pass';
                    testDiv.className = 'test-result test-result--pass';
                } else {
                    log(`${sensor.toUpperCase()} test FAILED: ${result.message}`, 'error');
                    statusSpan.textContent = '✗ Fail';
                    testDiv.className = 'test-result test-result--fail';
                }

                // Show details
                if (result.details) {
                    const detailStr = Object.entries(result.details)
                        .map(([k, v]) => `${k}: ${JSON.stringify(v)}`)
                        .join(', ');
                    detailsDiv.textContent = detailStr;
                }

            } catch (error) {
                log(`${sensor.toUpperCase()} test ERROR: ${error.message}`, 'error');
                statusSpan.textContent = '✗ Error';
                testDiv.className = 'test-result test-result--fail';
                testResults[sensor] = { passed: false, message: error.message };
            }

            updateSummary();
        }

        // Run all tests sequentially
        async function runAllTests() {
            log('=== Starting All Tests ===', 'info');
            resetTests();

            const sensors = ['adc', 'imu', 'rtc', 'sd', 'neopixel', 'battery'];

            for (const sensor of sensors) {
                await runTest(sensor);
                await new Promise(r => setTimeout(r, 500)); // Brief pause between tests
            }

            log('=== All Tests Complete ===', 'info');

            const summary = calculateSummary();
            if (summary.fail === 0 && summary.pass === summary.total) {
                log('OVERALL RESULT: ALL TESTS PASSED', 'success');
            } else {
                log(`OVERALL RESULT: ${summary.fail} TEST(S) FAILED`, 'error');
            }
        }

        // Reset all tests
        function resetTests() {
            const sensors = ['adc', 'imu', 'rtc', 'sd', 'neopixel', 'battery'];

            sensors.forEach(sensor => {
                testResults[sensor] = null;
                const testDiv = document.getElementById(`test-${sensor}`);
                const statusSpan = document.getElementById(`test-${sensor}-status`);

                testDiv.className = 'test-result test-result--pending';
                statusSpan.textContent = 'Pending';
            });

            updateSummary();
            log('Tests reset', 'info');
        }

        // Calculate test summary
        function calculateSummary() {
            const sensors = Object.keys(testResults);
            let pass = 0, fail = 0, pending = 0;

            sensors.forEach(sensor => {
                if (testResults[sensor] === null) {
                    pending++;
                } else if (testResults[sensor].passed) {
                    pass++;
                } else {
                    fail++;
                }
            });

            return { total: sensors.length, pass, fail, pending };
        }

        // Update summary display
        function updateSummary() {
            const summary = calculateSummary();

            document.getElementById('summary-total').textContent = summary.total;
            document.getElementById('summary-pass').textContent = summary.pass;
            document.getElementById('summary-fail').textContent = summary.fail;
            document.getElementById('summary-pending').textContent = summary.pending;

            const resultEl = document.getElementById('summary-result');
            if (summary.pending === summary.total) {
                resultEl.textContent = '--';
                resultEl.style.color = 'var(--text-muted)';
            } else if (summary.fail > 0) {
                resultEl.textContent = 'FAIL';
                resultEl.style.color = 'var(--accent-red)';
            } else if (summary.pending === 0) {
                resultEl.textContent = 'PASS';
                resultEl.style.color = 'var(--accent-green)';
            } else {
                resultEl.textContent = '...';
                resultEl.style.color = 'var(--accent-orange)';
            }
        }

        // ========================================================================
        // LED Test Functions
        // ========================================================================

        let ledCycling = false;
        let selectedColor = 'red';
        let selectedPattern = 'steady';

        // Fetch and update LED state display
        async function refreshLedState() {
            try {
                const state = await API.get('/api/led');
                document.getElementById('led-state-name').textContent = state.state_name || '--';
                document.getElementById('led-state-progress').textContent =
                    `${(state.state_index || 0) + 1} / ${state.state_count || 0}`;

                ledCycling = state.cycling || false;
                updateCycleButton();
            } catch (error) {
                console.error('Failed to fetch LED state:', error);
            }
        }

        // Update cycle button appearance
        function updateCycleButton() {
            const btn = document.getElementById('btn-cycle-toggle');
            const indicator = document.getElementById('led-cycle-indicator');

            if (ledCycling) {
                btn.textContent = '⏹ Stop Auto Cycle';
                btn.className = 'btn btn--secondary';
                indicator.style.display = 'block';
            } else {
                btn.textContent = '▶ Start Auto Cycle';
                btn.className = 'btn btn--primary';
                indicator.style.display = 'none';
            }
        }

        // Toggle auto-cycle
        async function toggleAutoCycle() {
            try {
                if (ledCycling) {
                    await API.post('/api/led/cycle/stop', {});
                    log('LED auto-cycle stopped');
                } else {
                    await API.post('/api/led/cycle/start', { interval_ms: 1500 });
                    log('LED auto-cycle started (1.5s interval)');
                }
                await refreshLedState();
            } catch (error) {
                log(`Failed to toggle cycle: ${error.message}`, 'error');
            }
        }

        // Advance to next LED state
        async function ledNext() {
            try {
                const result = await API.post('/api/led/next', {});
                log(`LED: ${result.state_name}`);
                await refreshLedState();
            } catch (error) {
                log(`Failed to advance LED: ${error.message}`, 'error');
            }
        }

        // Set LED color with current pattern
        async function setLed(color) {
            selectedColor = color;
            log(`Setting LED: ${color} (${selectedPattern})`);
            try {
                await API.post('/api/led', {
                    color: color,
                    pattern: selectedPattern
                });
                await refreshLedState();
            } catch (error) {
                log(`Failed to set LED: ${error.message}`, 'error');
            }
        }

        // Set pattern and apply to current color
        async function setPattern(pattern) {
            selectedPattern = pattern;

            // Update button styles
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.classList.remove('btn--primary');
                btn.classList.add('btn--secondary');
            });
            const activeBtn = document.querySelector(`[data-pattern="${pattern}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn--secondary');
                activeBtn.classList.add('btn--primary');
            }

            log(`Pattern: ${pattern}`);
            try {
                await API.post('/api/led', {
                    color: selectedColor,
                    pattern: pattern
                });
                await refreshLedState();
            } catch (error) {
                log(`Failed to set pattern: ${error.message}`, 'error');
            }
        }

        // Set error blink code
        async function setBlinkCode(count) {
            log(`Setting error blink code: ${count} blinks`);
            try {
                await API.post('/api/led', {
                    color: 'red',
                    pattern: 'blink_code',
                    blink_count: count
                });
                await refreshLedState();
            } catch (error) {
                log(`Failed to set blink code: ${error.message}`, 'error');
            }
        }

        // Exit factory mode
        async function exitFactoryMode() {
            // Stop auto-cycling before exit
            if (ledCycling) {
                await API.post('/api/led/cycle/stop', {});
            }

            const success = await Mode.switchTo('user');
            if (success) {
                location.href = 'index.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Factory Test Mode initialized');
            updateSummary();

            // Verify we're in factory mode
            Mode.fetch().then(mode => {
                if (mode !== 'factory') {
                    UI.showAlert('Not in Factory mode. Please switch modes from the main page.', 'warning');
                }
            });

            // Fetch initial LED state
            refreshLedState();

            // Periodically refresh LED state when cycling
            setInterval(() => {
                if (ledCycling) {
                    refreshLedState();
                }
            }, 500);
        });
    </script>
</body>

</html>