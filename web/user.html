<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Loadcell Datalogger</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Chart container styles */
        .chart-container {
            position: relative;
            height: 250px;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        /* Live value display */
        .live-value {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            line-height: 1;
        }

        .live-unit {
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        /* File list */
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-input);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }

        .file-item:hover {
            background: var(--bg-hover);
        }

        .file-item__name {
            font-family: monospace;
            color: var(--accent-cyan);
        }

        .file-item__meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header__title">
            <a href="index.html" style="color: inherit; text-decoration: none;">← Back</a>
            &nbsp;|&nbsp; User Dashboard
        </div>
        <div class="flex gap-md">
            <span class="mode-badge mode-badge--user">USER</span>
        </div>
    </header>

    <div class="container">
        <!-- Live Data Display -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Live Data</h2>
                <div class="flex gap-sm">
                    <button class="btn btn--success" id="btn-start-log" onclick="toggleLogging()">
                        ▶ Start Logging
                    </button>
                </div>
            </div>

            <!-- Integrity Status (shown when logging) -->
            <div id="integrity-status" class="integrity-status" style="display: none; margin-bottom: 1rem;">
                <div class="flex items-center gap-md"
                    style="background: rgba(0,0,0,0.3); padding: 0.5rem 1rem; border-radius: 8px;">
                    <span class="status-indicator" id="integrity-led"
                        style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></span>
                    <span style="font-weight: 600;">Data Integrity</span>
                    <span class="text-muted">|</span>
                    <span>Buffer: <span id="integrity-buffer"
                            style="font-family: monospace; color: #22c55e;">0%</span></span>
                    <span class="text-muted">|</span>
                    <span>Latency: <span id="integrity-latency" style="font-family: monospace;">0ms</span></span>
                    <span class="text-muted">|</span>
                    <span>Drops: <span id="integrity-drops" style="font-family: monospace;">0</span></span>
                </div>
            </div>

            <div class="grid grid--3">
                <div class="stat-card" style="text-align: center;">
                    <div class="live-value stat-card__value--green" id="live-load">0.00</div>
                    <div class="live-unit">kg</div>
                    <div class="stat-card__label mt-sm">Load</div>
                </div>

                <div class="stat-card" style="text-align: center;">
                    <div class="live-value stat-card__value--blue" id="live-adc">0</div>
                    <div class="live-unit">raw</div>
                    <div class="stat-card__label mt-sm">ADC Reading</div>
                </div>

                <div class="stat-card" style="text-align: center;">
                    <div class="live-value" id="live-rate">0</div>
                    <div class="live-unit">sps</div>
                    <div class="stat-card__label mt-sm">Sample Rate</div>
                </div>
            </div>
        </div>

        <!-- Load Chart -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Load History</h2>
                <div class="flex gap-sm">
                    <button class="btn btn--small btn--secondary" onclick="clearChart()">Clear</button>
                    <select class="form-select" style="width: auto;" id="chart-timespan"
                        onchange="setChartTimespan(this.value)">
                        <option value="10">10 seconds</option>
                        <option value="30" selected>30 seconds</option>
                        <option value="60">1 minute</option>
                        <option value="300">5 minutes</option>
                    </select>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="load-chart" class="chart-canvas"></canvas>
                <div class="chart-placeholder" id="chart-placeholder">
                    Live chart will appear here when data is available
                </div>
            </div>
        </div>

        <!-- IMU Data -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">IMU Data</h2>
            </div>

            <div class="grid grid--2">
                <div>
                    <h4>Accelerometer</h4>
                    <div class="grid grid--3" style="text-align: center;">
                        <div>
                            <div class="text-muted">X</div>
                            <div style="font-family: monospace; font-size: 1.2rem;" id="imu-ax">0.00</div>
                            <div class="text-muted">g</div>
                        </div>
                        <div>
                            <div class="text-muted">Y</div>
                            <div style="font-family: monospace; font-size: 1.2rem;" id="imu-ay">0.00</div>
                            <div class="text-muted">g</div>
                        </div>
                        <div>
                            <div class="text-muted">Z</div>
                            <div style="font-family: monospace; font-size: 1.2rem;" id="imu-az">1.00</div>
                            <div class="text-muted">g</div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4>Gyroscope</h4>
                    <div class="grid grid--3" style="text-align: center;">
                        <div>
                            <div class="text-muted">X</div>
                            <div style="font-family: monospace; font-size: 1.2rem;" id="imu-gx">0.0</div>
                            <div class="text-muted">°/s</div>
                        </div>
                        <div>
                            <div class="text-muted">Y</div>
                            <div style="font-family: monospace; font-size: 1.2rem;" id="imu-gy">0.0</div>
                            <div class="text-muted">°/s</div>
                        </div>
                        <div>
                            <div class="text-muted">Z</div>
                            <div style="font-family: monospace; font-size: 1.2rem;" id="imu-gz">0.0</div>
                            <div class="text-muted">°/s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Summary (shown after logging stops) -->
        <div class="card" id="session-summary"
            style="display: none; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #0f3460;">
            <div class="card__header">
                <h2 class="card__title" style="color: #e94560;">Session Summary</h2>
                <button class="btn btn--small btn--secondary" onclick="hideSessionSummary()">Dismiss</button>
            </div>

            <div class="grid grid--2" style="gap: 2rem;">
                <div class="stat-card" style="background: rgba(233, 69, 96, 0.1); border-left: 4px solid #e94560;">
                    <div class="stat-card__label" style="color: #e94560;">Peak Load</div>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #fff;" id="summary-peak-load">--</div>
                    <div class="stat-card__value--small">N</div>
                    <div style="margin-top: 0.5rem; color: #94a3b8;">
                        at <span id="summary-peak-load-time">--</span>s
                    </div>
                </div>

                <div class="stat-card" style="background: rgba(0, 173, 181, 0.1); border-left: 4px solid #00adb5;">
                    <div class="stat-card__label" style="color: #00adb5;">Peak Deceleration</div>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #fff;" id="summary-peak-decel">--</div>
                    <div class="stat-card__value--small">g</div>
                    <div style="margin-top: 0.5rem; color: #94a3b8;">
                        at <span id="summary-peak-decel-time">--</span>s
                    </div>
                </div>
            </div>

            <div class="grid grid--4" style="margin-top: 1.5rem; text-align: center;">
                <div>
                    <div class="text-muted">Duration</div>
                    <div style="font-size: 1.2rem; font-weight: 600;" id="summary-duration">--</div>
                </div>
                <div>
                    <div class="text-muted">ADC Samples</div>
                    <div style="font-size: 1.2rem; font-weight: 600;" id="summary-adc-samples">--</div>
                </div>
                <div>
                    <div class="text-muted">IMU Samples</div>
                    <div style="font-size: 1.2rem; font-weight: 600;" id="summary-imu-samples">--</div>
                </div>
                <div>
                    <div class="text-muted">Dropped</div>
                    <div style="font-size: 1.2rem; font-weight: 600;" id="summary-dropped">--</div>
                </div>
            </div>
        </div>

        <!-- SD Card & Battery -->
        <div class="grid grid--2">
            <!-- SD Card Stats -->
            <div class="card">
                <div class="card__header">
                    <h2 class="card__title">SD Card Storage</h2>
                    <span class="status-dot status-dot--success" id="sd-status-dot"></span>
                </div>

                <div class="stat-card" style="text-align: center;">
                    <div class="stat-card__value stat-card__value--blue" id="sd-used">--</div>
                    <div class="stat-card__label">Used</div>
                </div>

                <div class="progress-bar mt-md">
                    <div class="progress-bar__fill" id="sd-progress" style="width: 0%;"></div>
                </div>

                <div class="flex mt-sm" style="justify-content: space-between;">
                    <span class="text-muted" id="sd-free">-- free</span>
                    <span class="text-muted" id="sd-total">of -- total</span>
                </div>

                <div class="mt-md">
                    <span class="text-muted">Files: </span>
                    <span id="sd-file-count">--</span>
                </div>
            </div>

            <!-- Battery Status -->
            <div class="card">
                <div class="card__header">
                    <h2 class="card__title">Battery</h2>
                    <span id="battery-charging" class="text-muted hidden">⚡ Charging</span>
                </div>

                <div class="stat-card" style="text-align: center;">
                    <div class="stat-card__value stat-card__value--green" id="battery-percent">--</div>
                    <div class="stat-card__label">%</div>
                </div>

                <div class="progress-bar mt-md">
                    <div class="progress-bar__fill progress-bar__fill--success" id="battery-progress"
                        style="width: 75%;"></div>
                </div>

                <div class="mt-md text-center">
                    <span class="text-muted">Voltage: </span>
                    <span id="battery-voltage">--</span>
                </div>
            </div>
        </div>

        <!-- Log Files -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">Log Files</h2>
                <button class="btn btn--small btn--secondary" onclick="refreshFiles()">↻ Refresh</button>
            </div>

            <div id="file-list">
                <div class="text-muted text-center">Loading files...</div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card">
            <div class="card__header">
                <h2 class="card__title">System Information</h2>
            </div>

            <div class="grid grid--4">
                <div>
                    <div class="text-muted">Uptime</div>
                    <div id="sys-uptime">--</div>
                </div>
                <div>
                    <div class="text-muted">Free Heap</div>
                    <div id="sys-heap">--</div>
                </div>
                <div>
                    <div class="text-muted">WiFi Signal</div>
                    <div id="sys-rssi">--</div>
                </div>
                <div>
                    <div class="text-muted">Temperature</div>
                    <div id="sys-temp">--</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module" src="js/user-page.js"></script>
</body>

</html>