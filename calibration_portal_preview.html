<!DOCTYPE html>
<html>

<head>
     <title>Calibration Portal - Loadcell Datalogger</title>
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <style>
          * {
               box-sizing: border-box;
          }

          body {
               font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               margin: 0;
               padding: 20px;
               background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
               min-height: 100vh;
          }

          .container {
               max-width: 800px;
               margin: 0 auto;
               background: white;
               padding: 30px;
               border-radius: 12px;
               box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
          }

          h1 {
               color: #2d3748;
               border-bottom: 3px solid #667eea;
               padding-bottom: 15px;
               margin-bottom: 25px;
          }

          .warning {
               background: #fff3cd;
               border: 2px solid #ffc107;
               border-radius: 8px;
               padding: 15px;
               margin-bottom: 25px;
               color: #856404;
          }

          .warning strong {
               display: block;
               margin-bottom: 8px;
          }

          .form-group {
               margin-bottom: 20px;
          }

          label {
               display: block;
               font-weight: 600;
               color: #4a5568;
               margin-bottom: 8px;
          }

          input[type="number"] {
               width: 100%;
               padding: 12px;
               border: 2px solid #e2e8f0;
               border-radius: 6px;
               font-size: 16px;
               transition: border-color 0.2s;
          }

          input[type="number"]:focus {
               outline: none;
               border-color: #667eea;
          }

          small {
               display: block;
               margin-top: 5px;
               font-size: 13px;
          }

          .button {
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               color: white;
               border: none;
               padding: 12px 24px;
               border-radius: 6px;
               font-size: 16px;
               font-weight: 600;
               cursor: pointer;
               transition: transform 0.2s, box-shadow 0.2s;
          }

          .button:hover {
               transform: translateY(-2px);
               box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
          }

          .button:active {
               transform: translateY(0);
          }

          .section {
               margin-bottom: 30px;
               padding: 20px;
               background: #f7fafc;
               border-radius: 8px;
          }

          .section h2 {
               color: #2d3748;
               margin-top: 0;
               margin-bottom: 15px;
          }

          .status {
               margin-top: 15px;
               padding: 12px;
               border-radius: 6px;
               font-weight: 500;
               animation: slideIn 0.3s ease-out;
          }

          @keyframes slideIn {
               from {
                    opacity: 0;
                    transform: translateY(-10px);
               }

               to {
                    opacity: 1;
                    transform: translateY(0);
               }
          }

          .status.success {
               background: #c6f6d5;
               color: #22543d;
          }

          .status.error {
               background: #fed7d7;
               color: #742a2a;
          }

          .status.info {
               background: #bee3f8;
               color: #2c5282;
          }

          .info-box {
               background: #e6f2ff;
               border-left: 4px solid #4299e1;
               padding: 15px;
               border-radius: 6px;
               margin-top: 15px;
          }

          .info-box h3 {
               margin-top: 0;
               color: #2c5282;
               font-size: 16px;
          }

          .info-box ul {
               margin: 10px 0;
               padding-left: 20px;
          }

          .info-box li {
               margin: 5px 0;
               color: #2c5282;
          }
     </style>
</head>

<body>
     <div class="container">
          <h1>üîß Calibration Portal</h1>

          <div class="warning">
               <strong>‚ö†Ô∏è Internal Use Only</strong>
               This portal is for initial loadcell calibration only. Do not share this URL with end users.
          </div>

          <div class="section">
               <h2>Loadcell Calibration</h2>
               <form id="calForm">
                    <div class="form-group">
                         <label for="loadcellScale">Scaling Factor (N per ADC count):</label>
                         <input type="number" id="loadcellScale" name="loadcellScale" step="0.000001" min="0.000001"
                              max="1000" required>
                         <small style="color: #718096;">Formula: Force (N) = (ADC_Code - Offset) √ó Scale</small>
                    </div>
                    <div class="form-group">
                         <label for="loadcellOffset">ADC Baseline/Offset (24-bit value):</label>
                         <input type="number" id="loadcellOffset" name="loadcellOffset" min="0" max="16777215" required>
                         <small style="color: #718096;">ADC value that corresponds to 0N (zero force). Typically
                              8,388,608 for 24-bit mid-point.</small>
                    </div>
               </form>
               <div id="calStatus"></div>
          </div>

          <div class="section">
               <h2>ADC Settings</h2>
               <form id="adcForm">
                    <div class="form-group">
                         <label for="adcSampleRate">ADC Sample Rate (Hz)</label>
                         <input type="number" id="adcSampleRate" name="adcSampleRate" value="64000" min="1000"
                              max="64000" step="1000">
                         <small>Range: 1,000 - 64,000 Hz</small>
                    </div>
                    <div class="form-group">
                         <label for="adcPgaGain">PGA Gain</label>
                         <select id="adcPgaGain" name="adcPgaGain">
                              <option value="0">x1</option>
                              <option value="1">x2</option>
                              <option value="2" selected>x4</option>
                              <option value="3">x8</option>
                              <option value="4">x16</option>
                              <option value="5">x32</option>
                              <option value="6">x64</option>
                              <option value="7">x128</option>
                         </select>
                    </div>
               </form>
          </div>

          <div class="section">
               <h2>IMU Settings</h2>
               <form id="imuForm">
                    <div class="form-group">
                         <label for="imuOdr">IMU Sample Rate (Hz)</label>
                         <input type="number" id="imuOdr" name="imuOdr" value="960" min="15" max="960" step="15">
                         <small>Range: 15 - 960 Hz</small>
                    </div>
                    <div class="form-group">
                         <label for="imuAccelRange">Accelerometer Range</label>
                         <select id="imuAccelRange" name="imuAccelRange">
                              <option value="2">¬±2g</option>
                              <option value="4">¬±4g</option>
                              <option value="8">¬±8g</option>
                              <option value="16" selected>¬±16g</option>
                         </select>
                    </div>
                    <div class="form-group">
                         <label for="imuGyroRange">Gyroscope Range</label>
                         <select id="imuGyroRange" name="imuGyroRange">
                              <option value="125">¬±125 dps</option>
                              <option value="250">¬±250 dps</option>
                              <option value="500">¬±500 dps</option>
                              <option value="1000">¬±1000 dps</option>
                              <option value="2000" selected>¬±2000 dps</option>
                         </select>
                    </div>
               </form>
          </div>

          <div class="section">
               <div class="button-group" style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" class="button" onclick="saveAllConfig()">üíæ Save All Settings</button>
                    <button type="button" class="button" style="background: #e2e8f0; color: #4a5568;"
                         onclick="loadAllConfig()">üì• Load Current Config</button>
               </div>
               <div id="configStatus"></div>
          </div>

          <div class="section">
               <div class="info-box">
                    <h3>üìã Calibration Instructions</h3>
                    <ul>
                         <li><strong>Scaling Factor:</strong> Determines how many Newtons each ADC count represents.
                              Calculate by: Scale = Known_Force (N) / (ADC_Code_at_Force - ADC_Baseline)</li>
                         <li><strong>ADC Baseline/Offset:</strong> The ADC value when no force is applied (0N).
                              For a 24-bit signed ADC, this is typically 2^23 = 8,388,608 (mid-point).</li>
                         <li><strong>Example:</strong> If applying 20kN (20,000N) results in ADC code 11,388,608:
                              <ul style="margin-top: 5px;">
                                   <li>Baseline = 8,388,608 (0N reference)</li>
                                   <li>Scale = 20,000 / (11,388,608 - 8,388,608) = 20,000 / 3,000,000 = 0.00667 N/ADC
                                   </li>
                              </ul>
                         </li>
                         <li>After calibration, these values are stored in NVS and used automatically for all future
                              measurements.</li>
                    </ul>
               </div>
          </div>
     </div>

     <script>
          // Mock calibration values (defaults from loadcell_cal.h)
          let mockCalibration = {
               scale: 0.00667,
               offset: 8388608
          };

          // Simulate loading calibration values
          function loadCalibration() {
               // In preview mode, use mock data
               if (window.location.protocol === 'file:') {
                    console.log('Preview mode: Using mock calibration values');
                    document.getElementById('loadcellScale').value = mockCalibration.scale;
                    document.getElementById('loadcellOffset').value = mockCalibration.offset;
                    return;
               }

               // Real mode: fetch from ESP32
               fetch('/cal/values')
                    .then(response => response.json())
                    .then(data => {
                         document.getElementById('loadcellScale').value = data.scale;
                         document.getElementById('loadcellOffset').value = data.offset;
                    })
                    .catch(error => {
                         console.error('Error loading calibration:', error);
                         // Fallback to defaults
                         document.getElementById('loadcellScale').value = mockCalibration.scale;
                         document.getElementById('loadcellOffset').value = mockCalibration.offset;
                    });
          }

          // Load all configuration (calibration + ADC/IMU)
          async function loadAllConfig() {
               await loadCalibration();
               await loadAdcImuConfig();
          }

          // Load ADC/IMU configuration
          async function loadAdcImuConfig() {
               // In preview mode, use defaults
               if (window.location.protocol === 'file:') {
                    document.getElementById('adcSampleRate').value = 64000;
                    document.getElementById('adcPgaGain').value = 2;
                    document.getElementById('imuOdr').value = 960;
                    document.getElementById('imuAccelRange').value = 16;
                    document.getElementById('imuGyroRange').value = 2000;
                    return;
               }

               try {
                    const response = await fetch('/config');
                    const config = await response.json();
                    document.getElementById('adcSampleRate').value = config.adcSampleRate || 64000;
                    document.getElementById('adcPgaGain').value = config.adcPgaGain || 2;
                    document.getElementById('imuOdr').value = config.imuOdr || 960;
                    document.getElementById('imuAccelRange').value = config.imuAccelRange || 16;
                    document.getElementById('imuGyroRange').value = config.imuGyroRange || 2000;
               } catch (error) {
                    console.error('Error loading ADC/IMU config:', error);
               }
          }

          // Save all configuration (calibration + ADC/IMU)
          async function saveAllConfig() {
               const statusDiv = document.getElementById('configStatus');
               statusDiv.className = 'status info';
               statusDiv.textContent = 'üíæ Saving all settings...';

               const scale = parseFloat(document.getElementById('loadcellScale').value);
               const offset = parseInt(document.getElementById('loadcellOffset').value);
               const adcRate = parseInt(document.getElementById('adcSampleRate').value);
               const adcGain = parseInt(document.getElementById('adcPgaGain').value);
               const imuOdr = parseInt(document.getElementById('imuOdr').value);
               const imuAccel = parseInt(document.getElementById('imuAccelRange').value);
               const imuGyro = parseInt(document.getElementById('imuGyroRange').value);

               // Validation
               if (scale <= 0 || scale > 1000) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Error: Scaling factor must be between 0.000001 and 1000';
                    return;
               }

               if (offset < 0 || offset > 16777215) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Error: ADC offset must be between 0 and 16777215';
                    return;
               }

               if (adcRate < 1000 || adcRate > 64000) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Error: ADC Sample Rate must be between 1,000 and 64,000 Hz';
                    return;
               }

               if (imuOdr < 15 || imuOdr > 960) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Error: IMU Sample Rate must be between 15 and 960 Hz';
                    return;
               }

               // In preview mode, simulate save
               if (window.location.protocol === 'file:') {
                    setTimeout(() => {
                         mockCalibration.scale = scale;
                         mockCalibration.offset = offset;
                         statusDiv.className = 'status success';
                         statusDiv.textContent = '‚úÖ All settings saved successfully! (Preview mode - values not actually saved)';
                         console.log('Mock settings saved:', { calibration: mockCalibration, adcRate, adcGain, imuOdr, imuAccel, imuGyro });
                    }, 500);
                    return;
               }

               // Real mode: POST to ESP32
               try {
                    // Save calibration
                    const calForm = document.getElementById('calForm');
                    const calFormData = new FormData(calForm);
                    const calParams = new URLSearchParams(calFormData);
                    const calResponse = await fetch('/cal', {
                         method: 'POST',
                         body: calParams
                    });

                    if (!calResponse.ok) {
                         statusDiv.className = 'status error';
                         statusDiv.textContent = '‚ùå Error saving calibration: ' + await calResponse.text();
                         return;
                    }

                    // Save ADC/IMU config
                    const configParams = new URLSearchParams({
                         adcSampleRate: adcRate,
                         adcPgaGain: adcGain,
                         imuOdr: imuOdr,
                         imuAccelRange: imuAccel,
                         imuGyroRange: imuGyro
                    });

                    const configResponse = await fetch('/config?' + configParams.toString(), {
                         method: 'POST'
                    });

                    if (configResponse.ok) {
                         statusDiv.className = 'status success';
                         statusDiv.textContent = '‚úÖ All settings saved successfully!';
                    } else {
                         statusDiv.className = 'status error';
                         statusDiv.textContent = '‚ùå Error saving ADC/IMU config: ' + await configResponse.text();
                    }
               } catch (error) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Error: ' + error;
               }
          }

          // Prevent form submission (use Save All Settings button instead)
          document.getElementById('calForm').addEventListener('submit', (e) => {
               e.preventDefault();
               saveAllConfig();
          });

          // Helper function to show status messages
          function showStatus(message, type) {
               const statusDiv = document.getElementById('calStatus');
               statusDiv.className = 'status ' + type;
               statusDiv.textContent = message;
          }

          // Load calibration on page load
          window.onload = function () {
               loadAllConfig();
          };
     </script>
</body>

</html>